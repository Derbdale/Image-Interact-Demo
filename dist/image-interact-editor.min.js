const ImageInteractEditor=function(){let t,i;function e(t,i){for(let e in i)i.hasOwnProperty(e)&&(t[e]=i[e])}function o(t,i){let e=t.x,o=t.y,n=i.x,s=i.y;return Math.sqrt((e-=n)*e+(o-=s)*o)}function n(t,i,e){let n;if(e.x-i.x)if(e.y-i.y){let o,s=-1/((e.y-i.y)/(e.x-i.x));n={x:o=(e.x*(t.x*s-t.y+i.y)+i.x*(t.x*-s+t.y-e.y))/(s*(e.x-i.x)+i.y-e.y),y:s*o-s*t.x+t.y}}else n={x:t.x,y:i.y};else n={x:i.x,y:t.y};if(n.x<Math.min(i.x,e.x)||n.x>Math.max(i.x,e.x)||n.y<Math.min(i.y,e.y)||n.y>Math.max(i.y,e.y)){const n=o(t,i),s=o(t,e);return n>s?s:n}{const o=i.y-e.y,n=e.x-i.x,s=i.x*e.y-i.y*e.x;return Math.abs(o*t.x+n*t.y+s)/Math.sqrt(o*o+n*n)}}function s(t,i,e){const o=t.x-i.x,n=t.y-i.y,s=e.x-i.x,r=e.y-i.y,a=s*s+r*r,d=o*s+n*r,h=Math.min(1,Math.max(0,d/a));return{x:i.x+s*h,y:i.y+r*h}}return function(t){t.Circle="circle",t.Square="rect"}(t||(t={})),function(t){t.Delete="delete",t.Pan="pan",t.Poly="poly",t.Point="point",t.Select="select"}(i||(i={})),class{constructor(o,n){this.version="1.0.0",this.decorations=[],this.currentDecoration=0,this.predictedPoint=null;const s=this;if(this.settings={constraintsEnabled:!0,eventHandler:o,pointType:t.Circle,pointSize:10,scaleFrom:void 0,plugins:{}},void 0!==n&&e(this.settings,n),this.lastWidth=o.offsetWidth,this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.classList.add("image-interact-editor-svg"),this.container=document.createElement("div"),this.container.className="image-interact-editor-container",this.wrapper=document.createElement("div"),this.wrapper.className="image-interact-editor-wrapper",this.editor=document.createElement("div"),this.editor.className="image-interact-editor",o.parentNode.insertBefore(this.container,o),this.container.appendChild(this.wrapper),this.wrapper.appendChild(this.editor),this.editor.appendChild(o),this.editor.appendChild(this.svg),this.editor.oncontextmenu=function(t){return t.preventDefault(),!1},void 0!==this.settings.plugins.panzoom)if(void 0!==panzoom){const t={bounds:!0,boundsPadding:1,minZoom:1,maxZoom:10,beforeMouseDown:s.allowPanning.bind(this),smoothScroll:!1},i=void 0!==this.settings.plugins.panzoom.options?this.settings.plugins.panzoom.options:{};e(i,t),this.panzoom=panzoom(this.editor,i),this.wrapper.addEventListener("wheel",function(){s.render()})}else console.log("Image Interact: Panzoom Library not found!");if(null!==o.getAttribute("usemap")){const t=document.querySelector('map[name="'+o.getAttribute("usemap").substr(1)+'"]'),i=void 0!==this.settings.scaleFrom?o.offsetWidth/this.settings.scaleFrom:1;t.querySelectorAll("area").forEach(function(t){s.decorations[s.currentDecoration]={type:"poly",data:[],options:{}};const e=t.getAttribute("coords");if(""!==e&&"0"!==e){const t=e.split(",").map(function(t){return t});for(let e=0;e<t.length;e+=2)s.decorations[s.currentDecoration].data.push({x:Math.round(t[e]*i),y:Math.round(t[e+1]*i)})}}),o.removeAttribute("usemap"),this.render()}this.switchMode(i.Poly),this.editor.onpointerdown=this.mouseDown.bind(s),this.editor.onpointermove=this.mouseMove.bind(s),this.editor.onpointerup=this.mouseUp.bind(s)}allowPanning(){return this.mode!=i.Pan}mouseDown(t){if(this.mode===i.Poly){if(t.stopPropagation(),void 0===this.currentDecoration)return!1;if(this.target=t.target,0===t.button){this.pointIndex=void 0;const i=this.editor.getBoundingClientRect();let e={x:t.pageX-i.left+document.body.scrollLeft,y:t.pageY-i.top+document.body.scrollTop};this.scalePoint(e),void 0===this.decorations[this.currentDecoration]&&(this.decorations[this.currentDecoration]={type:"poly",data:[],options:{}}),"svg"===this.target.tagName.toLowerCase()||1*this.target.getAttribute("data-shape-index")!==this.currentDecoration?null!==this.predictedPoint?(this.pointIndex=this.predictedPoint.insertAt,this.decorations[this.currentDecoration].data.splice(this.pointIndex,0,e),this.predictedPoint=null):(this.pointIndex=this.decorations[this.currentDecoration].data.length,this.decorations[this.currentDecoration].data[this.pointIndex]=e):this.target.tagName.toLowerCase()===this.settings.pointType?(this.pointIndex=this.target.getAttribute("data-point-index"),this.decorations[this.currentDecoration].data[this.pointIndex]=e):"polygon"===this.target.tagName.toLowerCase()&&(null!==this.predictedPoint?(this.pointIndex=this.predictedPoint.insertAt,this.decorations[this.currentDecoration].data.splice(this.pointIndex,0,e),this.target=this.target.parentElement,this.predictedPoint=null):this.pointIndex=this.decorations[this.currentDecoration].data.length,this.position=e)}else 2===t.button&&(this.target.tagName.toLowerCase()===this.settings.pointType&&1*this.target.getAttribute("data-shape-index")===this.currentDecoration&&(this.pointIndex=this.target.getAttribute("data-point-index"),this.decorations[this.currentDecoration].data.splice(this.pointIndex,1)),this.pointIndex=void 0,this.target=void 0);this.render()}}mouseMove(t){const e=this.editor.getBoundingClientRect();let r={x:t.pageX-e.left+document.body.scrollLeft,y:t.pageY-e.top+document.body.scrollTop};if(this.scalePoint(r),null!==this.predictedPoint&&(this.predictedPoint=null,this.render()),0===t.buttons){const i=t.target;if((!i.classList.contains("image-interact-point")||i.classList.contains("ghost"))&&void 0!==this.decorations[this.currentDecoration]){const t=this.decorations[this.currentDecoration].data[this.decorations[this.currentDecoration].data.length-1];let i=21;for(let e=0;e<this.decorations[this.currentDecoration].data.length-1;e++){const a=n(r,this.decorations[this.currentDecoration].data[e],this.decorations[this.currentDecoration].data[e+1]);if(a<=20&&a<i){const n=this.decorations[this.currentDecoration].data[e],d=this.decorations[this.currentDecoration].data[e+1],h=s(r,n,d),c=o(r,t);let p=!1;d.x===t.x&&d.y===t.y?a<c/2&&(p=!0):a<c&&(p=!0),p&&(this.predictedPoint={x:h.x,y:h.y,insertAt:e+1},i=a)}}null!==this.predictedPoint&&this.render()}}if(this.mode===i.Poly){if(t.stopPropagation(),void 0===this.currentDecoration)return!1;if(void 0!==this.target){if("polygon"===this.target.tagName.toLowerCase()&&1*this.target.getAttribute("data-shape-index")===this.currentDecoration&&null===this.predictedPoint)void 0!==this.pointIndex&&(this.decorations[this.currentDecoration].data.splice(this.pointIndex,1),this.pointIndex=void 0),this.movePoly(this.decorations[this.currentDecoration],r.x-this.position.x,r.y-this.position.y),this.position=r;else if(void 0!==this.pointIndex){if(t.shiftKey&&this.settings.constraintsEnabled){var a=this.decorations[this.currentDecoration].data[this.pointIndex-1],d=r.x-a.x,h=r.y-a.y,c=180*Math.atan2(h,d)/Math.PI;c<45&&c>-45||c>157.5||c<-157.5?r.y=a.y:r.x=a.x}this.decorations[this.currentDecoration].data[this.pointIndex]=r}this.render()}}}mouseUp(t){if(1===t.button&&(this.mode!=i.Pan?this.switchMode(i.Pan):this.switchMode(i.Poly)),this.mode===i.Poly){if(t.stopPropagation(),void 0===this.currentDecoration)return!1;if(void 0!==this.pointIndex){const i=this.editor.getBoundingClientRect();let r={x:t.pageX-i.left+document.body.scrollLeft,y:t.pageY-i.top+document.body.scrollTop};if(this.scalePoint(r),t.shiftKey&&this.settings.constraintsEnabled){var e=this.decorations[this.currentDecoration].data[this.pointIndex-1],o=r.x-e.x,n=r.y-e.y,s=180*Math.atan2(n,o)/Math.PI;s<45&&s>-45||s>157.5||s<-157.5?r.y=e.y:r.x=e.x}null!==this.predictedPoint?this.decorations[this.currentDecoration].data.splice(this.pointIndex,0,r):this.decorations[this.currentDecoration].data[this.pointIndex]=r}this.pointIndex=void 0,this.render(),this.target=void 0}}render(){const t=this,i=void 0!==this.panzoom?this.panzoom.getTransform().scale>10?.2:1/this.panzoom.getTransform().scale:1;for(;this.svg.firstChild;)this.svg.removeChild(this.svg.firstChild);function e(i,e,o){const n=document.createElementNS("http://www.w3.org/2000/svg",t.settings.pointType);if(n.classList.add("image-interact-point"),0!==e.length)for(let t=0;t<e.length;t++)n.classList.add(e[t]);return"circle"===t.settings.pointType?(n.setAttribute("r",t.settings.pointSize/2*o),n.setAttribute("cx",i.x),n.setAttribute("cy",i.y),n.style.strokeWidth=o,n):(n.setAttribute("x",i.x-t.settings.pointSize/2*o),n.setAttribute("y",i.y-t.settings.pointSize/2*o),n.setAttribute("width",t.settings.pointSize*o),n.setAttribute("height",t.settings.pointSize*o),n.style.strokeWidth=o,n)}function o(o,n){const s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("data-shape-index",o),o===t.currentDecoration&&s.classList.add("active");const r=document.createElementNS("http://www.w3.org/2000/svg","polygon");if(r.classList.add("image-interact-shape"),r.setAttribute("data-shape-index",o),r.setAttribute("points",n.data.map(function(t){return t.x+","+t.y}).join(",")),r.style.strokeWidth=i,s.appendChild(r),null!==t.predictedPoint){const o=e(t.predictedPoint,[],2*i);o.classList.add("ghost"),s.appendChild(o)}for(let r=0;r<n.data.length;r++){let a=[];void 0!==t.pointIndex&&(t.pointIndex===r?a.push("active"):a.push("inactive"));const d=e(n.data[r],a,i);d.setAttribute("data-shape-index",o),d.setAttribute("data-point-index",r),s.appendChild(d)}return s}for(let i=0;i<this.decorations.length;i++)if(void 0!==this.decorations[i]&&"poly"==this.decorations[i].type){const e=o(i,this.decorations[i]);t.svg.appendChild(e)}}scalePoint(t){if(void 0!==this.panzoom){let i=this.panzoom.getTransform().scale;t.x/=i,t.y/=i}}movePoly(t,i,e){for(let o=0;o<t.data.length;o++)t.data[o].x+=i,t.data[o].y+=e}switchMode(t){void 0!==this.mode&&this.wrapper.classList.remove(`${this.mode}-mode`),this.mode=t,this.wrapper.classList.add(`${this.mode}-mode`)}}}();
